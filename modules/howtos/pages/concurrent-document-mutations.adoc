= Concurrent Document Mutations
:page-topic-type: howto
include::partial$attributes.adoc[]
:page-aliases: ROOT:concurrent-document-mutations.adoc

include::6.5@sdk:shared:partial$cas.adoc[tag=intro]

include::6.5@sdk:shared:partial$cas.adoc[tag=demo]

include::6.5@sdk:shared:partial$cas.adoc[tag=example]

include::6.5@sdk:shared:partial$cas.adoc[tag=errors]

[source,php]
----
function incrementVisitCount(\Couchbase\Collection $collection, string $userId) {
    $maxRetries = 10;
    for ($i = 0; $i < $maxRetries; ++$i) {
        // Get the current document contents
        $getRes = $collection->get($userId);

        // Increment the visit count
        $userDoc = $getRes->content();
        $userDoc['visitCount']++;

        try {
            // Attempt to replace the document using CAS
            $options = new \Couchbase\ReplaceOptions();
            $options->cas($getRes->cas());
            $collection->replace($userId, $userDoc, $options);
        } catch (\Couchbase\CasMismatchError $ex) {
            continue;
        }

        // If no errors occured during the replace, we can exit our retry loop
        break;
    }
}
----

Sometimes more logic is needed when performing updates, for example, if a property is mutually exclusive with another property; only one or the other can exist, but not both.


include::6.5@sdk:shared:partial$cas.adoc[tag=performance]

include::6.5@sdk:shared:partial$cas.adoc[tag=format]

include::6.5@sdk:shared:partial$cas.adoc[tag=locking]

[source,php]
----
$getRes = $collection->getAndLock('key', 3 /* seconds */);
$lockedCas = $getRes->cas();

/*

 // an example of simply unlocking the document
 $collection->unlock('key', $lockedCas);

 */

$options = new \Couchbase\UpsertOptions();
$options->cas($lockedCas);
$collection->upsert('key', ['desc' => 'new value'], $options);
----

The handler will unlock the item either via an explicit unlock operation ([.api]`unlock`) or implicitly via modifying the item with the correct CAS.

If the item has already been locked, the server will respond with CasMismatch which means that the operation could not be executed temporarily, but may succeed later on.

